{
  "entities": {
    "QueueType": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QueueType",
      "type": "object",
      "description": "Defines a specific type of service or department for which students can generate a queue ticket, such as 'General Inquiry', 'Payment Services', or 'Enrollment Services'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QueueType entity."
        },
        "name": {
          "type": "string",
          "description": "A human-readable name for the queue type displayed to students and staff (e.g., 'General Inquiry', 'Payment Services')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the services provided under this queue type, helping students choose the correct queue."
        },
        "ticketPrefix": {
          "type": "string",
          "description": "A short alphanumeric prefix used for generating unique ticket display numbers (e.g., 'G' for General, 'P' for Payments)."
        },
        "nextTicketNumber": {
          "type": "number",
          "description": "The next sequential numerical identifier to be issued for a ticket within this queue type. This number is incremented upon each new ticket generation."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "ticketPrefix",
        "nextTicketNumber"
      ]
    },
    "QueueStation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QueueStation",
      "type": "object",
      "description": "Represents a physical service point within the training center, such as a counter or a cashier desk, where students are served.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QueueStation entity."
        },
        "name": {
          "type": "string",
          "description": "The public-facing display name of the station (e.g., 'Counter 1', 'Cashier Desk A')."
        },
        "stationNumber": {
          "type": "number",
          "description": "A numerical identifier for the station, typically displayed on public screens and staff interfaces."
        },
        "description": {
          "type": "string",
          "description": "A brief description of the station's primary function or physical location."
        },
        "operationalStatus": {
          "type": "string",
          "description": "Indicates whether the station is currently operational and accepting students ('Open') or not ('Closed').",
          "format": "enum",
          "items": {
            "type": "string"
          }
        },
        "currentTicketId": {
          "type": "string",
          "description": "Reference to the unique identifier of the QueueTicket currently being actively served at this station. Null if no ticket is being served. (Relationship: QueueStation 1:1 QueueTicket)"
        },
        "assignedQueueTypeIds": {
          "type": "array",
          "description": "An array of references to QueueType IDs that this station is configured to handle. This supports 'combo' or 'all-in-one' operational modes where a single station can serve multiple queue types. (Relationship: QueueStation N:N QueueType)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "stationNumber",
        "description",
        "operationalStatus",
        "assignedQueueTypeIds"
      ]
    },
    "QueueTicket": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QueueTicket",
      "type": "object",
      "description": "Represents a single queue ticket generated by a student, tracking its status and progression through the queue system from generation to service completion.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QueueTicket entity."
        },
        "ticketDisplayNumber": {
          "type": "string",
          "description": "The full displayable ticket number presented to the student and on public displays (e.g., 'G-001', 'P-123') including its prefix and sequential number."
        },
        "queueTypeId": {
          "type": "string",
          "description": "Reference to the unique identifier of the QueueType this ticket belongs to, indicating the service the student requested. (Relationship: QueueType 1:N QueueTicket)"
        },
        "status": {
          "type": "string",
          "description": "The current status of the ticket within the queue lifecycle.",
          "format": "enum",
          "items": {
            "type": "string"
          }
        },
        "generatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the ticket was initially generated by the student.",
          "format": "date-time"
        },
        "calledAt": {
          "type": "string",
          "description": "Timestamp indicating when the ticket was first called by a QueueStation. Null if the ticket has not yet been called.",
          "format": "date-time"
        },
        "servedAt": {
          "type": "string",
          "description": "Timestamp indicating when the ticket was marked as 'Served' by a QueueStation. Null if the ticket has not yet been served.",
          "format": "date-time"
        },
        "callingStationId": {
          "type": "string",
          "description": "Reference to the unique identifier of the QueueStation that is currently calling or serving this ticket. Null if the ticket is in 'Waiting' status. (Relationship: QueueStation 1:N QueueTicket)"
        },
        "calledCount": {
          "type": "number",
          "description": "The number of times this ticket has been called by any station. Useful for managing 'no-show' scenarios and determining re-call behavior."
        }
      },
      "required": [
        "id",
        "ticketDisplayNumber",
        "queueTypeId",
        "status",
        "generatedAt",
        "calledCount"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/queue_types/{queueTypeId}",
        "definition": {
          "entityName": "QueueType",
          "schema": {
            "$ref": "#/backend/entities/QueueType"
          },
          "description": "Collection for defining different types of queues (e.g., 'General Inquiry', 'Payment Services'). Globally accessible for students to select from and for public displays. Only administrative users can create, update, or delete these definitions. Supports atomic increment of `nextTicketNumber` for generating unique ticket IDs.",
          "params": [
            {
              "name": "queueTypeId",
              "description": "Unique identifier for a specific queue type."
            }
          ]
        }
      },
      {
        "path": "/queue_stations/{stationId}",
        "definition": {
          "entityName": "QueueStation",
          "schema": {
            "$ref": "#/backend/entities/QueueStation"
          },
          "description": "Collection for physical service points (e.g., 'Counter 1', 'Cashier Desk A'). Globally accessible for public displays to show status. Includes `currentOperatorUid` (added to schema) for immediate staff authorization against this specific station, enhancing Authorization Independence for operational updates (e.g., setting `operationalStatus`, `currentTicketId`). Administrative users can configure `assignedQueueTypeIds` and other static properties. Staff assigned to a station (via `currentOperatorUid`) can update operational status fields.",
          "params": [
            {
              "name": "stationId",
              "description": "Unique identifier for a specific queue station."
            }
          ]
        }
      },
      {
        "path": "/queue_tickets/{ticketId}",
        "definition": {
          "entityName": "QueueTicket",
          "schema": {
            "$ref": "#/backend/entities/QueueTicket"
          },
          "description": "Collection for individual queue tickets generated by students. Globally accessible for public displays to show real-time queue status. Students (anonymous or authenticated) can create new tickets. Staff can update ticket statuses (e.g., 'CALLED', 'SERVED') via the `callingStationId` by being the `currentOperatorUid` of that station. Authorization for staff updates relies on `callingStationId` matching the staff's currently operated station (`QueueStation.currentOperatorUid`).",
          "params": [
            {
              "name": "ticketId",
              "description": "Unique identifier for a specific queue ticket."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{adminUid}",
        "definition": {
          "entityName": "AdminRole",
          "schema": {
            "$ref": "#/backend/entities/AdminRole"
          },
          "description": "A dedicated collection for defining administrative users. The existence of a document at `/roles_admin/{uid}` grants administrative privileges. Authorization for global administrative tasks (e.g., managing queue types and station configurations) is based on checking the existence of this document for `request.auth.uid`, supporting the DBAC principle.",
          "params": [
            {
              "name": "adminUid",
              "description": "The Firebase Authentication UID of an administrative user."
            }
          ]
        }
      },
      {
        "path": "/staff_assignments/{staffUid}",
        "definition": {
          "entityName": "StaffAssignment",
          "schema": {
            "$ref": "#/backend/entities/StaffAssignment"
          },
          "description": "A dedicated collection to identify users as staff members. The existence of a document at `/staff_assignments/{uid}` signifies that `uid` is a staff member. This document acts as a primary staff role marker. Specific operational authorization for staff (e.g., managing a particular QueueStation) is further controlled by the `QueueStation.currentOperatorUid` field.",
          "params": [
            {
              "name": "staffUid",
              "description": "The Firebase Authentication UID of a staff user."
            }
          ]
        }
      }
    ],
    "reasoning": "The proposed Firestore structure for NaviQueue Pro prioritizes security, scalability, and debuggability by adhering to the core design principles and strategy mandates. The system employs a flat collection structure for `QueueType`, `QueueStation`, and `QueueTicket` to optimize for diverse query patterns (public displays, staff interfaces) and simplify security rules. Administrative and staff roles are managed through dedicated top-level collections (`/roles_admin` and `/staff_assignments`) based on the DBAC principle, relying on document existence for authorization.\n\n**Authorization Independence via Denormalization:**\n\n1.  **`QueueStation` Authorization:** To achieve authorization independence for staff operating a `QueueStation`, each `QueueStation` document includes a `currentOperatorUid` field. When a staff member logs into and begins operating a station, their `request.auth.uid` is explicitly written to this field. This allows subsequent operational updates to the `QueueStation` (e.g., changing `operationalStatus`, `currentTicketId`) to be authorized atomically by simply checking `request.auth.uid == resource.data.currentOperatorUid` within the `queue_stations` collection's rules. This eliminates the need for `get()` calls to a separate staff assignment collection for *operational* authorization, greatly simplifying and securing atomic transactions.\n2.  **`QueueTicket` Authorization:** `QueueTicket` documents contain `queueTypeId` and `callingStationId` which link them to their respective entities. When a staff member *calls* a ticket, they are doing so on behalf of the station they are operating. Authorization for `QueueTicket` updates (e.g., changing status to 'Served', 'Missed') will be enforced by ensuring that `request.auth.uid` matches the `currentOperatorUid` of the `callingStationId` associated with the ticket. While this does involve a `get()` call to the `queue_stations` collection, it's not a 'hierarchical dependency' in the sense of a parent-child relationship of the *document being written*. Instead, it's a relational check against a related authorization context (`QueueStation`'s `currentOperatorUid`), which is a common and acceptable pattern for ensuring staff are authorized to perform actions via their active station.\n\n**QAPs (Rules are not Filters):**\n\n*   **`QueueType` and `QueueStation`:** These collections are designed to be globally readable. Public displays can efficiently `list` all `queue_types` and `queue_stations` without needing complex filters, directly supporting the public display requirements. Security rules will simply allow reads for all. \n*   **`QueueTicket`:** This collection is also globally readable for public displays. Public displays can `list` all `queue_tickets` to show current status. Staff interfaces can query `queue_tickets` filtered by `queueTypeId` and `status` to find waiting tickets for their assigned types. Since the `status` and `callingStationId` are explicit, efficient queries are supported, and security rules don't need to filter sensitive data from `list` operations, as sensitive data is not stored within these documents. Any required access restrictions are at the write level, not the read level, and are enforced through explicit role checks and the denormalized `currentOperatorUid` on `QueueStation`.\n\nThis design ensures that authorization rules are kept simple, explicit, and easy to debug, while providing the flexibility required by the 'combo mode' feature and the varying access patterns of students, public displays, and staff."
  }
}